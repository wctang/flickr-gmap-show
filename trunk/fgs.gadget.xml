<?xml version="1.0" encoding="UTF-8"?>
<Module>
<ModulePrefs title="__MSG_title__" description="__MSG_description__" 
author="wctang" author_photo="http://farm1.static.flickr.com/219/buddyicons/81718017@N00.jpg" author_email="wctang+fgsfeedback@gmail.com"
author_link="http://blog.wctang.info/" author_location="Kaohsiung, Taiwan" author_affiliation="wctang.info"
title_url="http://code.google.com/p/flickr-gmap-show/" screenshot="http://flickr-gmap-show.googlecode.com/svn/trunk/pics/fgs_gadget_preview.png"
thumbnail="http://flickr-gmap-show.googlecode.com/svn/trunk/pics/fgs_gadget_thumb.png" height="400" scrolling="true" category="tools">
  <Locale messages="http://flickr-gmap-show.googlecode.com/svn/trunk/msg-en.xml"/>
  <Locale lang="zh-TW" messages="http://flickr-gmap-show.googlecode.com/svn/trunk/msg-zh-tw.xml"/>
  <Require feature="setprefs"/>
  <Require feature="analytics"/>
  <Require feature="minimessage"/>
</ModulePrefs>
<UserPref name="usepanoramio" display_name="__MSG_usepanoramio__" datatype="bool" default_value="true"/>
<UserPref name="lat" default_value="0" datatype="hidden" />
<UserPref name="lng" default_value="0" datatype="hidden" />
<UserPref name="zoom" default_value="12" datatype="hidden" />

<Content type="html"><![CDATA[
<style type="text/css">
#mapDiv {
/*    border:1px solid #979797; */
    margin-top:10px;
    margin-bottom:10px;
    width:100%;
    height:350px;
}
#settingDiv, #pageDiv {
    margin-bottom:5px;
}
#fgs_search_form {
    display:inline;
}

img {
    border:0px;
}

.mask {
    background:black;
    opacity:.8;
    -moz-opacity:.8;
    filter:alpha(opacity=80);
}
.mask div {
    background:white;
}

a.btn {
    cursor:pointer;
}
a.right {
    float:right;
}
a.btn img {
    cursor:pointer;
}

#popupall {
}

.photoPanel {
    height:140px;
    width:255px;
    border:0px;
}
.photoPanel div {
    position:relative; 
    left:0px; 
    width:255px; 
    background:white;
}
.photoPanel .photos img.flickr,
#popupall img.flickr {
    margin:4px;
    border:solid 1px #FF0084;
    cursor:pointer;
}
.photoPanel .photos img.panoramio,
#popupall img.panoramio {
    margin:4px;
    border:solid 1px #006BB8;
    cursor:pointer;
}

.popup {
    font-size: 12px; 
    background:white;
}

</style>

<div id="mapDiv"></div>
<div id='pageDiv'></div>
<div style="display:none;" id="settingDiv"></div>

<script src="http://maps.google.com/maps?file=api&amp;v=2.x" type="text/javascript"></script>
<script src="http://yui.yahooapis.com/2.2.2/build/yahoo-dom-event/yahoo-dom-event.js"></script>
<script src="http://yui.yahooapis.com/2.2.2/build/animation/animation-min.js"></script>
<script type="text/javascript">
var _uacct = "UA-359113-4";

var msg = new _IG_MiniMessage(__MODULE_ID__);
var prefs = new _IG_Prefs(__MODULE_ID__);

var msg_date = '__MSG_date__';
var msg_sort = '__MSG_sort__';
var msg_datetakendesc = '__MSG_datetakendesc__';
var msg_datetakenasc = '__MSG_datetakenasc__';
var msg_dateposteddesc = '__MSG_dateposteddesc__';
var msg_datepostedasc = '__MSG_datepostedasc__';
var msg_interestingnessdesc = '__MSG_interestingnessdesc__';
var msg_interestingnessasc = '__MSG_interestingnessasc__';
var msg_relevance = '__MSG_relevance__';
var msg_search = '__MSG_search__';
var msg_currpage = '__MSG_currpage__';
var msg_viewonsite = '__MSG_viewonsite__';
var msg_takenon = '__MSG_takenon__';
var msg_postby = '__MSG_postby__';
var msg_prevpage = '__MSG_prevpage__';
var msg_nextpage = '__MSG_nextpage__';
var msg_toggle = '__MSG_toggle__';



//---------------------------------
//-- flickr gmap show common api --
//---------------------------------

var isIE = (window.navigator.appName.indexOf('Internet Explorer')!=-1);

var imgdir = 'http://flickr-gmap-show.googlecode.com/svn/trunk/pics/';
var imgs = {
    loading : imgdir+'loading.gif',
    close_default : imgdir+'simple_close_default.gif',
    close_hover   : imgdir+'simple_close_hover.gif',
    close_selected: imgdir+'simple_close_selected.gif',
    popup_default : imgdir+'simple_new_window_default.gif',
    popup_hover   : imgdir+'simple_new_window_hover.gif',
    popup_selected: imgdir+'simple_new_window_selected.gif',
    updown_default : imgdir+'simple_updown_default.gif',
    updown_hover   : imgdir+'simple_updown_hover.gif',
    updown_selected: imgdir+'simple_updown_selected.gif',
    prev_default  : imgdir+'simple_prev_default.gif',
    prev_hover    : imgdir+'simple_prev_hover.gif',
    prev_selected : imgdir+'simple_prev_selected.gif',
    next_default  : imgdir+'simple_next_default.gif',
    next_hover    : imgdir+'simple_next_hover.gif',
    next_selected : imgdir+'simple_next_selected.gif'
};

for(var m in imgs) {
    var mm = new Image();
    mm.src = imgs[m];
    imgs[m] = mm;
}

var deltas = [0,0,0,0,0,
0.7558876745860973,
0.4381797339583715,
0.2166893459120705,
0.1054534198706207,
0.0517575120441158,
0.0256017451528869,
0.012732042885645,
0.00634837196261628,
0.003169749786363714,
0.001583755663266591,
0.0007915970919446143,
0.0003957279865313504,
0.0001978462849822430,
0.0000989186817588934,
0.0000494593408794467];
var MAX_ZOOM = 19;
var MIN_ZOOM = 5;
var PER_PAGE = 100;


// utility
function $(e) { return document.getElementById(e); };
function $c(e) { return document.createElement(e); };
function $a(e,a) { return e.getAttribute(a); };
function $dom(s) { var d=$c('div');d.innerHTML=s;return d.firstChild; };
function $extend(subc,basec) { 
    function inheritance(){}; inheritance.prototype=basec.prototype; subc.prototype=new inheritance(); 
    subc.prototype.constructor = subc; subc.prototype.baseConstructor = basec; subc.superClass = basec.prototype;
};
function $cbtn(n, title, clickfun, targetObj) {
    var a = $dom('<a class="btn"><img src="'+imgs[n+'_default'].src+'"/></a>');
    a.n=n;
    a.onmouseout=function(){ this.firstChild.src = imgs[this.n+'_default'].src;};
    a.onmouseover=function(){ this.firstChild.src = imgs[this.n+'_hover'].src;};
    a.onmousedown=function(){ this.firstChild.src = imgs[this.n+'_selected'].src;};
    a.onmouseup=function(){ this.firstChild.src = imgs[this.n+'_hover'].src;};
    if(clickfun && targetObj) {
        a.onclick=function(){clickfun.call(targetObj);};
    } else if(clickfun) {
        a.onclick=clickfun;
    }
    if(title) a.title=title;
    return a;
};
var icons=[];
function $icon(n) {
    if(n > 100) n = 100;
    if(!icons[n]) {
        var img = new GIcon(null,imgdir + n + ".png");
        if(n < 10) {
            img.iconSize = new GSize(18, 19);
            img.iconAnchor = new GPoint(9, 9);
            img.infoWindowAnchor = new GPoint(9, 9);
        } else if (n < 100) {
            img.iconSize = new GSize(20, 21);
            img.iconAnchor = new GPoint(10, 10);
            img.infoWindowAnchor = new GPoint(10, 10);
        } else {
            img.iconSize = new GSize(26, 27);
            img.iconAnchor = new GPoint(13, 13);
            img.infoWindowAnchor = new GPoint(13, 13);
        }
        icons[n] = img;
    }
    return icons[n];
};


// flickr
flickr = {
name:'flickr',
_api_key : "ebed0eef1b25b738b1903ef93b8f25ee",
_secret_key : "4260ccd8c3f7837e",

gettitle : function(photo) {return photo.title;},
iconurl: function(photo) {return'http://farm'+photo.farm+'.static.flickr.com/'+photo.server+'/'+photo.id+'_'+photo.secret+'_s.jpg';},
smallurl: function(photo) {return'http://farm'+photo.farm+'.static.flickr.com/'+photo.server+'/'+photo.id+'_'+photo.secret+'_m.jpg';},
pageurl : function(photo) {return 'http://www.flickr.com/photo.gne?id='+photo.id;},
owner: function(photo) {return photo.ownername ? photo.ownername : photo.owner;},
ownerurl: function(photo) {return 'http://www.flickr.com/photos/'+photo.owner+'/';},
hasbuddy: true,
buddyurl : function(photo) {
    if(photo.iconserver&parseInt(photo.iconserver)>0) return 'http://farm'+photo.iconfarm+'.static.flickr.com/'+photo.iconserver+'/buddyicons/'+photo.owner+'.jpg';
    else return 'http://www.flickr.com/images/buddyicon.jpg';
},
date: function(photo) { return photo.datetaken.substr(0,10); },
_url : function(args, sign) {
    var url = 'http://api.flickr.com/services/rest/?'
    var signature = flickr._secret_key;
    var keys = [];
    for (var k in args) { keys.push(k); }
    keys.sort();
    for (var i=0; i<keys.length; i++) {
        var k = keys[i];
        var v = args[k];
//        signature = signature + k + v;
        url += (i>0?'&':'') + _esc(k) + '=' + _esc(v);
    }
//    if(sign) {
//        signature = Utilities.MD5(signature);
//        url = url + '&api_sig='+signature;
//    }
    return url;
},
callapi : function(args, obj, callback, timestamp, parms, sign) {
    args.api_key = flickr._api_key;
    args.format = 'json';
    args.nojsoncallback = '1';
    if (flickr._token) { args.auth_token = flickr._token; }

    _IG_FetchContent(flickr._url(args, sign), function(str) {
        var rsp = null;
        try {
            if(timestamp == obj.timestamp && str) {
                rsp = eval('(' + str + ')');
                if(!rsp || rsp.stat != 'ok') rsp = null;
            }
        } finally {
            var photos = null;
            var total = 0;
            if(rsp && typeof rsp == 'object') {
                photos = rsp.photos.photo;
                total = parseInt(rsp.photos.total);
            }
            callback.call(obj, flickr, photos, total, timestamp, parms);
        }
    });
}
};


// panoramio
panoramio = {
name:'Panoramio',
gettitle : function(photo) {return photo.photo_title;},
iconurl: function(photo) {return photo.photo_file_url.replace('medium','square');},
smallurl: function(photo) {return photo.photo_file_url.replace('medium','small');},
pageurl : function(photo) {return photo.photo_url;},
owner: function(photo) {return photo.owner_name;},
ownerurl: function(photo) {return photo.owner_url;},
hasbuddy: false,
date: function(photo) { return photo.upload_date; },
_url : function(args, sign) {
    var url = 'http://www.panoramio.com/map/get_panoramas.php?'
    var keys = [];
    for (var k in args) { keys.push(k); }
    keys.sort();
    for (var i=0; i<keys.length; i++) {
        var k = keys[i];
        var v = args[k];
        url += (i>0?'&':'') + _esc(k) + '=' + _esc(v);
    }
    return url;
},
callapi : function(args, obj, callback, timestamp, parms, sign) {
    _IG_FetchContent(panoramio._url(args, sign), function(str) {
        var rsp = null;
        try {
            if(timestamp == obj.timestamp && str) {
                rsp = eval('(' + str + ')');
            }
        } finally {
            var photos = null;
            var total = 0;
            if(rsp && typeof rsp == 'object') {
                photos = rsp.photos;
                total = rsp.count;
            }
            callback.call(obj, panoramio, photos, total, timestamp, parms);
        }
    });
}
};


// FPhotoMarker
//   overwrite function
//     onOpenInfoWindow
function FPhotoMarker(icon, photos, bounds) {
    var position = bounds.getCenter();
    FPhotoMarker.prototype.baseConstructor.call(this, position, {icon:icon});

    this.photos = photos;
    this.currpos = 0;
    this.ctx = null;
    GEvent.addListener(this, 'click', this.onClick);
};
$extend(FPhotoMarker, GMarker);
FPhotoMarker.prototype.refreshImgList = function(dir) {
    var imags = this.ctx.imags;
    
    var end = this.currpos + 5;
    if( end > imags.length) end = imags.length;
    for( var i = this.currpos; i<end; ++i) {
        var img = imags[i];
        if(!img.src) img.src=img.photo.api.iconurl(img.photo);
    }

    function disappear() {
        this.getEl().style.display='none';
    };

    var c = this.currpos;
    for( var i = 0; i < imags.length; i++ ) {
        var img=imags[i];
        var s=img.style;
        
        var attr=null;
        if(dir==0 || isIE) {
            switch(i) {
                case c-1: s.display='inline'; s.left='8px';  s.top='8px'; s.width=s.height='60px'; break;
                case c  : s.display='inline'; s.left='85px'; s.top='0px'; s.width=s.height='75px'; break;
                case c+1: s.display='inline'; s.left='178px';s.top='8px'; s.width=s.height='60px'; break;
                default:  s.display='none'; break;
            }
        } else if(dir>0) {
            switch(i) {
                case c-2: s.display='inline'; s.left='8px';  s.top='8px'; s.width=s.height='60px'; attr={left:{to:0},top:{to:0},width:{to:0},height:{to:0}}; break;
                case c-1: s.display='inline'; s.left='85px'; s.top='0px'; s.width=s.height='75px'; attr={left:{to:8},top:{to:8},width:{to:60},height:{to:60}}; break;
                case c  : s.display='inline'; s.left='178px';s.top='8px'; s.width=s.height='60px'; attr={left:{to:85},top:{to:0},width:{to:75},height:{to:75}};break;
                case c+1: s.display='inline'; s.left='245px';s.top='75px';s.width=s.height='0px';  attr={left:{to:178},top:{to:8},width:{to:60},height:{to:60}}; break;
                default:  s.display='none'; break;
            }
        } else if(dir<0) {
            var attr=null;
            switch(i) {
                case c-1: s.display='inline'; s.left='0px';  s.top='0px'; s.width=s.height='0px';  attr={left:{to:8},top:{to:8},width:{to:60},height:{to:60}}; break;
                case c  : s.display='inline'; s.left='8px';  s.top='8px'; s.width=s.height='60px'; attr={left:{to:85},top:{to:0},width:{to:75},height:{to:75}}; break;
                case c+1: s.display='inline'; s.left='85px'; s.top='0px'; s.width=s.height='75px'; attr={left:{to:178},top:{to:8},width:{to:60},height:{to:60}};break;
                case c+2: s.display='inline'; s.left='178px';s.top='8px'; s.width=s.height='60px'; attr={left:{to:245},top:{to:75},width:{to:0},height:{to:0}}; break;
                default:  s.display='none'; break;
            }
        }
        if(attr) {
            var myAnim = new YAHOO.util.Motion(img, attr,.5, YAHOO.util.Easing.easeOutStrong);
            if((i==this.currpos-2) || (i==this.currpos+2)) myAnim.onComplete.subscribe(disappear);
            myAnim.animate();
        }
    }

    this.ctx.titl.innerHTML=imags[this.currpos].alt;
    this.ctx.info.innerHTML=' ' + (this.currpos+1) + ' of ' + imags.length + ' ';
};
FPhotoMarker.prototype.onClick = function() {
    if(!this.ctx) {
        var ctx_ = $dom(
            '<div class="photoPanel">'+
                '<div style="height:40px; text-align:center;"></div>'+
                '<div style="height:85px;" class="photos"></div>'+
                '<div style="height:20px;"></div>'+
            '</div>');
        ctx_.titl = ctx_.childNodes[0];
        var imags = ctx_.childNodes[1];
        var ctrl = ctx_.childNodes[2];

        var mx = $cbtn('popup','Popup', this.onMax, this);
        mx.className += ' right';
        var pre = $cbtn('prev',msg_prevpage, this.prevImg, this);
        var nex = $cbtn('next',msg_nextpage, this.nextImg, this);
        ctrl.appendChild(mx);
        ctrl.appendChild(pre);
        ctrl.appendChild(nex);

        var info = $dom('<span/>');
        ctrl.appendChild(info);
        ctx_.info = info;


        for(var i = 0, len = this.photos.length; i < len; ++i) {
            var photo = this.photos[i];

            var img = $c('img');
            img.alt = photo.api.gettitle(photo);
            img.className = photo.api.name;
            img.photo=photo;
            img.marker=this;
            img.onclick = this.onPhotoClick;
            img.style.position='absolute';
            img.style.width=img.style.height='75px';
            img.style.display='none';

            imags.appendChild(img);
        }
        this.ctx=ctx_;
        this.ctx.imags=imags.childNodes;
    }

    this.refreshImgList(0);
    this.onOpenInfoWindow();
}; 
FPhotoMarker.prototype.nextImg = function() {
    if(this.currpos >= this.ctx.imags.length-1) return;

    this.currpos++;
    this.refreshImgList(1);
};
FPhotoMarker.prototype.prevImg = function() {
    if( this.currpos <= 0) return;

    this.currpos--;
    this.refreshImgList(-1);
};
FPhotoMarker.prototype.onPhotoClick = function() {
    var w = document.body.clientWidth;
    var h = document.body.clientHeight;
    var overlay = $dom(
        '<div><div class="mask" style="position:absolute; top:0px; left:0px; width:'+w+'px; height:'+h+'px;">'+
            '<div style="position:absolute; top:100px; left:'+(w-32)/2+'px;">'+
                '<img src="'+imgs['loading'].src+'"/>'+
            '</div>'+
        '</div></div>');

    var imgPreloader = new Image();
    imgPreloader.onload=function(){
        if( this.overlay.removed) return;

        var photopopup = this.imglnk.marker.onPopupPhoto.call(this.imglnk.marker, this.imglnk.photo, this.width, this.height, this.src);
        this.overlay.firstChild.firstChild.style.display='none';
        this.overlay.appendChild(photopopup);
    };
    overlay.imgPreloader = imgPreloader;
    imgPreloader.overlay = overlay;
    imgPreloader.imglnk=this;
    imgPreloader.src = this.photo.api.smallurl(this.photo);

    overlay.onclick=function() {
        this.removed=true;
        this.parentNode.removeChild(this);
    };
    document.body.appendChild(overlay);
};




// FBrowser
//   overwrite function
//     updateviewCallback 
//     ondragend
//     clearPanel
//     newMaker
function FBrowser() {
    FBrowser.prototype.baseConstructor.apply(this, arguments);
    this.pageCurr = 1;
    this.pageTotal = 1;
    this.currZoom = 0;
    this._lastcenter = null;
    this.cleardata = false;
    this.timestamp = 0;
    this.currBounds = null;

    GEvent.addListener(this, "dragend", this.ondragend);
    GEvent.addListener(this, "zoomend", this.onzoomend);

    var nowy = new Date().getFullYear();
    var settingstr = '<span>'+msg_date+'<select id="fgs_select_year">';
    for(var i = 0; i<10; ++i) {
        settingstr += '<option value="'+(nowy-i)+'">'+(nowy-i)+'</option>';
    }
    settingstr += '</select> - <select id="fgs_select_month"><option value="all">All</option>';
    for(var i = 1; i<=12; ++i) {
        if(i < 10) settingstr += '<option value="0'+i+'">0'+i+'</option>';
        else       settingstr += '<option value="'+i+'">'+i+'</option>';
    }
    settingstr += 
        '</select><br />'+msg_sort+'<select id="fgs_select_sort">'+
            '<option value="interestingness-desc">'+msg_interestingnessdesc+'</option>'+
            '<option value="interestingness-asc">'+msg_interestingnessasc+'</option>'+
            '<option value="date-taken-desc">'+msg_datetakendesc+'</option>'+
            '<option value="date-taken-asc">'+msg_datetakenasc+'</option>'+
            '<option value="date-posted-desc">'+msg_dateposteddesc+'</option>'+
            '<option value="date-posted-asc">'+msg_datepostedasc+'</option>'+
            '<option value="relevance">'+msg_relevance+'</option></select>';
    settingstr += '<br />'+msg_search+'<form id="fgs_search_form"><input id="fgs_search" type="text"/><input type="submit"/></form></span>';
    settingDiv.appendChild($dom(settingstr));
    var ysel = $('fgs_select_year');
    var msel = $('fgs_select_month');
    var ssel = $('fgs_select_sort');
    var sform = $('fgs_search_form');
    ysel.map = msel.map = ssel.map = sform.map = this;
    ysel.onchange = msel.onchange = ssel.onchange = sform.onsubmit = this.changeSetting;

    var pre = $cbtn('prev',msg_prevpage, this.prevPage, this);
    var nex = $cbtn('next',msg_nextpage, this.nextPage, this);
    var pageInfo = $dom('<span/>');
    pageDiv.appendChild(pre);
    pageDiv.appendChild(nex);
    pageDiv.appendChild(pageInfo);
    pageDiv.pageInfo = pageInfo;
    pre.map = nex.map = this;
};
$extend(FBrowser, GMap2);
FBrowser.prototype.updateview = function(bound, currPage, level) {
    if(level) {
        this.currZoom = level;
    }
    if( this.currZoom < MIN_ZOOM || this.currZoom > MAX_ZOOM) {
        return;
    }
    if(currPage) {
        this.pageCurr = currPage;
    } else {
        this.pageCurr = 1;
        this.pageTotal = 1;
    }

    this.updateviewCallback(bound);
};
FBrowser.prototype.changeSetting = function() {
    this.map.updateview();
    return false;
};
FBrowser.prototype.prevPage = function() {
    if( this.pageCurr <= 1) return;

    this.updateview(null, this.pageCurr-1);
};
FBrowser.prototype.nextPage = function() {
    if( this.pageCurr >= this.pageTotal) return;

    this.updateview(null, this.pageCurr+1);
};
FBrowser.prototype.onzoomend = function(oldLevel,newLevel) {
    this.updateview(null, null, newLevel);
};
FBrowser.prototype.refreshData = function(bound) {
    var sw = bound.getSouthWest();
    var ne = bound.getNorthEast();
    var w = sw.lng();
    var e = ne.lng();
    var n = ne.lat();
    var s = sw.lat();
    var span = bound.toSpan();
    var wid = span.lng();
    var hig = span.lat();

    w += wid/5;
    if( w > 180) w -= 360;
    e -= wid/5;
    if( e <= -180) e += 360;

    if( e < w) {
        if( (180+e) > (180-w)) {
            w = -180;
        } else {
            e = 180;
        }
    }
    n-=hig/5;
    s+=hig/5;

    
    var year = $('fgs_select_year').value;
    var month = $('fgs_select_month').value;
    var sort = $('fgs_select_sort').value;
    var searchtxt = $('fgs_search').value;

    var max_date, min_date;
    if(month == 'all') {
        min_date = year+'-01-01'; max_date = year+'-12-31';
    } else {
        min_date = year+'-'+month+'-01'; max_date = year+'-'+month+'-31';
    }

    var points = [];
    points.push(new GLatLng(n,e));
    points.push(new GLatLng(n,w));
    points.push(new GLatLng(s,w));
    points.push(new GLatLng(s,e));
    points.push(new GLatLng(n,e));

    this.cleardata = true;
    this.timestamp = new Date().getTime();
    if(_trim(searchtxt)) {
        flickr.callapi({method: 'flickr.photos.search',  extras:'geo,date_taken,owner_name,icon_server', bbox:w+','+s+','+e+','+n, text:_trim(searchtxt), min_taken_date:min_date, max_taken_date:max_date, sort:sort, page:this.pageCurr, per_page:PER_PAGE}, this, this.search_callback, this.timestamp, [points]);
    } else {
        flickr.callapi({method: 'flickr.photos.search',  extras:'geo,date_taken,owner_name,icon_server', bbox:w+','+s+','+e+','+n,                        min_taken_date:min_date, max_taken_date:max_date, sort:sort, page:this.pageCurr, per_page:PER_PAGE}, this, this.search_callback, this.timestamp, [points]);
    }

    if( prefs.getBool('usepanoramio')) {
        var psort = null;
        var pset = null;
        if(sort == 'interestingness-desc' || sort == 'interestingness-asc' || sort == 'relevance') {
            psort = 'popularity';
            pset = 'public';
        } else {
            psort = 'upload_date';
            pset = 'full';
        }
        panoramio.callapi({from:(this.pageCurr-1)*PER_PAGE, to:this.pageCurr*PER_PAGE, order:psort, set:pset, minx:w, miny:s, maxx:e, maxy:n}, this, this.search_callback, this.timestamp, [points]);
    }
};
FBrowser.prototype.search_callback = function(api, photos, total, timestamp, params) {
    if(!photos) return;
    if(timestamp != this.timestamp) return;

    var points = params[0];

    try {
        if(this.cleardata) {
            this.cleardata = false;
            this.currBounds = new Array();
            this.clearOverlays();
            this.total = 0;
            this.start = 0;
            this.end = 0;
        }

        var pp = total/PER_PAGE;
        if( pp > this.pageTotal) this.pageTotal = pp;
        this.total += total;

        if( photos.length == 0)
            this.start += total;
        else
            this.start += ((this.pageCurr-1)*PER_PAGE);

        this.end += photos.length;
        
        var start = this.start+1;
        var end = this.start + this.end;
        if(start > end) start = end;
        
        pageDiv.pageInfo.innerHTML = ' '+msg_currpage.replace('$1', start).replace('$2', end).replace('$3', this.total);
        setTimeout('onsize()', 300);

        for (var i=0,len=photos.length; i<len; i++) {
            photos[i].api = api;
        }
        
        this.update_photos(api, photos, points);
    } finally {
        this.onReceivedData();
    }
};
FBrowser.prototype.update_photos = function(api, photos, points) {
    var delta = deltas[this.currZoom];

    var temp_bounds = this.currBounds;
    for (var i=0,len=photos.length; i<len; i++) {
        var photo = photos[i];
        var lat = parseFloat(photo.latitude);
        var lon = parseFloat(photo.longitude);
        if(lat == 0 && lon == 0) { continue; }

        var pos = new GLatLng(lat, lon);

        var isMerged = false;
        for (var j=0,len2=temp_bounds.length; j<len2; j++) {
            var b = temp_bounds[j];
            if( b.contains(pos)) {
                isMerged = true;
                b.photos.push(photo);
                break;
            }
        }

        if(!isMerged) {
            var b = new GLatLngBounds(new GLatLng(pos.lat()-delta, pos.lng()-delta), new GLatLng(pos.lat()+delta, pos.lng()+delta));
            b.photos=new Array();
            b.photos.push(photo);
            temp_bounds.push(b);
        }
    }

    this.clearPanel();
    //this.closeInfoWindow();
    this.addOverlay(new GPolyline(points, '#0000FF', 1, .3));

    for (var i=0,len=temp_bounds.length; i<len ; i++) {
        var b = temp_bounds[i];
        if(b.photos.length == 0) { continue; }
        if(b.maker) this.removeOverlay(b.maker);
        b.maker = this.newMaker($icon(b.photos.length), b.photos, b);
        this.addOverlay(b.maker);
    }
};

//-- flickr gmap show common api --







var mapDiv = $('mapDiv');
var pageDiv = $('pageDiv');
var settingDiv = $('settingDiv');

function onsize() {
    if(settingDiv.style.display=='none') {
        mapDiv.style.height = (document.body.clientHeight-pageDiv.offsetHeight-30)+'px';
        mapDiv.gmap.checkResize();
    } else {
        mapDiv.style.height = (document.body.clientHeight-pageDiv.offsetHeight-settingDiv.offsetHeight-40)+'px';
        mapDiv.gmap.checkResize();
    }
};
window.onresize=onsize;
function toggle() {
    if(settingDiv.style.display=='none') {
        settingDiv.style.display='block';
    } else {
        settingDiv.style.display='none';
    }
    onsize();
};
var upbtn = $cbtn('updown',msg_toggle, toggle);
upbtn.className += ' right';
pageDiv.appendChild(upbtn);





// mask layer
function mask(gmap) {
    if(!mask.layer) {
        mask.layer = $dom(
    '<div class="mask" style="position:absolute; top:0px; left:0px; cursor:wait; display:none;">'+
        '<div style="position:absolute; top:100px;">'+
            '<img src="http://flickr-gmap-show.googlecode.com/svn/trunk/pics/loading.gif"/>'+
        '</div>'+
    '</div>')
        mapDiv.appendChild(mask.layer);
    }
    var w = mapDiv.clientWidth;
    var h = mapDiv.clientHeight;
    mask.layer.style.width = w+'px';
    mask.layer.style.height = h+'px';
    mask.layer.firstChild.style.left = (w-32)/2 + 'px';
    mask.layer.style.display = 'block';
};
function unmask() {
    mask.layer.style.display = 'none';
};






var centerMap = [];
var FGS = {
    init : function() {
        _IG_Analytics(_uacct, "/gedget");
        var locale = _args()["lang"];
        centerMap["en"] = new GLatLng(37.7750, -122.4183);   // san francisco
        centerMap["fr"] = new GLatLng(48.8565, 2.3509);      // paris
        centerMap["de"] = new GLatLng(52.5238, 13.4119);     // berlin
        centerMap["es"] = new GLatLng(40.4167, -3.7032);     // madrid
        centerMap["it"] = new GLatLng(45.4637, 9.1881);      // milan
        centerMap["nl"] = new GLatLng(52.3738, 4.8909);      // amsterdam
        centerMap["ja"] = new GLatLng(35.6699, 139.7700);    // tokyo
        centerMap["zh-TW"] = new GLatLng(25.0555,121.5374);    // taipei


        var mapCenterLatLng = null;
        
        var lat = parseFloat(prefs.getString('lat'));
        var lng = parseFloat(prefs.getString('lng'));
        if ( lat && lng ) {
            mapCenterLatLng = new GLatLng(lat, lng);
        }

        if(!mapCenterLatLng) {
            mapCenterLatLng = centerMap["en"];
            if ( centerMap[locale] ) {
                mapCenterLatLng = centerMap[locale];
            }
        }


function FPhotoMarkerGadget() {
    FPhotoMarkerGadget.prototype.baseConstructor.apply(this, arguments);
};
$extend(FPhotoMarkerGadget, FPhotoMarker);
FPhotoMarkerGadget.prototype.onOpenInfoWindow = function() {
    this.openInfoWindow(this.ctx);
};
FPhotoMarkerGadget.prototype.onPopupPhoto = function(photo, width, height, src) {
    var w = width+20;
    var lef = (document.body.clientWidth-w)/2;
    if(lef < 0) lef=0;

    var hei = (document.body.clientHeight-(height+100))/2;
    if(hei < 0) hei=0;

    var photoctx =
        '<div class="popup" style="position:absolute; top:'+hei+'px; left:'+lef+'px; width:'+w+'px;">'+
            '<div style="margin:10px;">'+
                '<b style="display: block; margin-bottom: 4px;">'+photo.api.gettitle(photo)+'</b>'+
                '<img style="margin-bottom:4px;" src="'+src+'"/><br />';
    if(photo.api.hasbuddy)
        photoctx += '<a style="float:right;" target="_blank" href="'+photo.api.ownerurl(photo)+'"/><img style="width:48px;height:48px;border:0px;" src="'+flickr.buddyurl(photo)+'"/></a>';
    photoctx += 
                '<i>'+msg_postby.replace('$1','<a target="_blank" href="'+photo.api.ownerurl(photo)+'"/>'+photo.api.owner(photo)+'</a>')+'</i><br />'+
                '<i>'+msg_takenon.replace('$1', photo.api.date(photo))+'</i><br />'+
                '<a target="_blank" href="'+photo.api.pageurl(photo)+'">'+msg_viewonsite.replace('$1',photo.api.name)+'</a>'+
            '</div>'+
        '</div>';
    return $dom(photoctx);
};
FPhotoMarkerGadget.prototype.onMax = function() {
    mapDiv.gmap.closeInfoWindow();
    var popup = $dom(
        '<div id="popupall" style="position:absolute;background:white;left:10px;top:10px;border:solid 1px black;">'+
            '<div style="height:20px; margin:3px;"></div>'+
            '<div style="overflow:auto;width:95%"><div></div></div>'+
        '</div>');
    popup.onclose = function() {this.parentNode.removeChild(this);};
    var titlePanel = popup.childNodes[0];
    var photoContainer = popup.childNodes[1];
    var photoPanel = photoContainer.firstChild;
    var closebtn = $cbtn('close','Close',popup.onclose,popup);
    closebtn.className += ' right';
    titlePanel.appendChild(closebtn);

    popup.style.width=(document.body.clientWidth-20)+'px';
    popup.style.height=(document.body.clientHeight-20)+'px';
    photoContainer.style.height=(document.body.clientHeight-50)+'px';

    var imags = this.ctx.imags;
    for( var i=0,len=imags.length; i<len; ++i) {
        var oimg = imags[i];
        var img = $c('img');
        img.alt = oimg.alt;
        img.marker=oimg.marker;
        img.photo = oimg.photo;
        if(oimg.src) img.src = oimg.src;
        else img.src=img.photo.api.iconurl(img.photo);
        img.onclick = this.onPhotoClick;
        img.className = img.photo.api.name;
        img.style.width=img.style.height='75px';
        photoPanel.appendChild(img);
    }
    
    document.body.appendChild(popup);
};



function FBrowserGadget() {
    FBrowserGadget.prototype.baseConstructor.apply(this, arguments);
};
$extend(FBrowserGadget, FBrowser);
FBrowserGadget.prototype.updateviewCallback = function(bound) {
    mask(this);
    if(!bound) {
        bound = this.getBounds();
    }
    this._lastcenter = bound.getCenter();

    prefs.set('lat', this._lastcenter.lat()+'');
    prefs.set('lng', this._lastcenter.lng()+'');
    prefs.set('zoom', this.currZoom+'');

    this.refreshData(bound);
};
FBrowserGadget.prototype.ondragend = function() {
    var bound = this.getBounds();
    var center = bound.getCenter();
    var span   = bound.toSpan();
    if(this._lastcenter) {
        var deltaX  = Math.abs(center.lng() - this._lastcenter.lng());
        var deltaY  = Math.abs(center.lat() - this._lastcenter.lat());
        var boundsX = span.lng();
        var boundsY = span.lat();
        if ((deltaX < 0.3*boundsX) && (deltaY < 0.3*boundsY)) {
            return;
        }
    }
    this.updateview(bound);
};
FBrowserGadget.prototype.clearPanel = function() {
};
FBrowserGadget.prototype.newMaker = function(icon, photos, bound) {
    return new FPhotoMarkerGadget(icon, photos, bound);
};
FBrowserGadget.prototype.onReceivedData = function() {
    unmask();
};


        var zoom = parseInt(prefs.getString('zoom'));
        var gmap = new FBrowserGadget(mapDiv);
        mapDiv.gmap = gmap;
        gmap.addControl(new GSmallMapControl());
        gmap.addControl(new GMapTypeControl());
        gmap.setCenter(mapCenterLatLng, zoom);
    }
};

_IG_RegisterOnloadHandler(FGS.init);
</script>
]]></Content>

</Module>
